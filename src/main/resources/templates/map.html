<!-- map.html -->
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Live GPS Tracking Map</title>
	<!-- Leaflet CSS & JS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
	<!-- WebSocket libraries -->
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			overflow: hidden;
			font-family: Arial, Helvetica, sans-serif;
		}

		#map {
			height: 100vh;
			width: 100vw;
		}

		.info-panel {
			position: absolute;
			top: 10px;
			right: 10px;
			background: rgba(255, 255, 255, 0.95);
			padding: 16px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			z-index: 1000;
			max-width: 300px;
		}

		.info-panel h3 {
			margin: 0 0 12px 0;
			font-size: 14px;
			color: #333;
			font-weight: 600;
		}

		.info-panel p {
			margin: 4px 0;
			font-size: 12px;
			color: #666;
		}

		.status {
			display: inline-block;
			width: 8px;
			height: 8px;
			border-radius: 50%;
			margin-right: 6px;
		}

		.status.connected {
			background: #4CAF50;
		}

		.status.disconnected {
			background: #f44336;
		}

		.active-users-label {
			margin-top: 12px;
			font-size: 12px;
			font-weight: 600;
			color: #333;
			margin-bottom: 6px;
		}

		.active-users-box {
			max-height: 200px;
			border: 1px solid #ddd;
			border-radius: 4px;
			background: #fafafa;
			overflow-y: auto;
		}

		.user-item {
			padding: 8px 10px;
			border-bottom: 1px solid #e0e0e0;
			cursor: pointer;
			font-size: 12px;
			color: #333;
			transition: background-color 0.2s;
		}

		.user-item:hover {
			background: #e3f2fd;
			color: #1976D2;
		}

		.user-item:last-child {
			border-bottom: none;
		}

		.empty-users {
			padding: 12px 10px;
			text-align: center;
			font-size: 12px;
			color: #999;
		}

		button {
			margin-top: 12px;
			padding: 8px 12px;
			background: #2196F3;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 12px;
			width: 100%;
			font-weight: 600;
		}

		button:hover {
			background: #1976D2;
		}
	</style>
</head>

<body>
	<div id="map"></div>
	<div class="info-panel">
		<h3><span class="status disconnected" id="status"></span>Live Tracking</h3>
		<p>Active Users: <strong id="userCount">0</strong></p>
		<p>Last Update: <span id="lastUpdate">Never</span></p>

		<div class="active-users-label">Active Users:</div>
		<div class="active-users-box" id="activeUsersList"></div>

		<button onclick="showAllMarkers()">View All</button>
	</div>

	<script>
		let stompClient = null;
		let map = L.map('map').setView([20.5937, 78.9629], 5);
		let markers = {};
		let markerGroup = L.layerGroup().addTo(map);
		let lastUpdateTimes = {};
		let inactivityTimeout = {};

		// Add OpenStreetMap tiles
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: 'Â© OpenStreetMap contributors',
			maxZoom: 19
		}).addTo(map);

		// Auto-connect on page load
		connectWebSocket();

		function connectWebSocket() {
			const socket = new SockJS('/ws');
			stompClient = Stomp.over(socket);
			if (stompClient && stompClient.debug) stompClient.debug = null;

			stompClient.connect({}, function (frame) {
				console.log('WebSocket Connected: ' + frame);
				updateStatus(true);

				// Subscribe to location updates
				stompClient.subscribe('/topic/location', function (message) {
					try {
						const data = JSON.parse(message.body);
						updateMarker(
							data.username || 'unknown',
							parseFloat(data.latitude),
							parseFloat(data.longitude)
						);
					} catch (e) {
						console.error('Failed to parse message', e, message.body);
					}
				});

				// Subscribe to user disconnection events
				stompClient.subscribe('/topic/user-disconnected', function (message) {
					try {
						const data = JSON.parse(message.body);
						removeMarker(data.username || 'unknown');
					} catch (e) {
						console.error('Failed to parse disconnect message', e);
					}
				});

			}, function (err) {
				console.error('STOMP connection error:', err);
				updateStatus(false);
				setTimeout(connectWebSocket, 5000);
			});
		}

		function updateMarker(username, lat, lon) {
			if (!isFinite(lat) || !isFinite(lon)) return;

			const now = new Date();
			lastUpdateTimes[username] = now;

			// Clear previous inactivity timeout if exists
			if (inactivityTimeout[username]) {
				clearTimeout(inactivityTimeout[username]);
			}

			// Set new inactivity timeout (30 seconds)
			inactivityTimeout[username] = setTimeout(() => {
				console.log('User inactive: ' + username);
				removeMarker(username);
			}, 5000);

			if (markers[username]) {
				// Update existing marker
				markers[username].setLatLng([lat, lon]);
				markers[username].getPopup().setContent(
					`<b>${username}</b><br>` +
					`Lat: ${lat.toFixed(6)}<br>` +
					`Lon: ${lon.toFixed(6)}<br>` +
					`<small>Updated: ${now.toLocaleTimeString()}</small>`
				);
			} else {
				// Create new marker with custom icon
				const customIcon = L.divIcon({
					className: 'custom-marker',
					html: `<div style="background: #2196F3; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
					iconSize: [16, 16],
					iconAnchor: [8, 8]
				});

				const m = L.marker([lat, lon], {icon: customIcon})
					.bindPopup(
						`<b>${username}</b><br>` +
						`Lat: ${lat.toFixed(6)}<br>` +
						`Lon: ${lon.toFixed(6)}<br>` +
						`<small>Updated: ${now.toLocaleTimeString()}</small>`, {
						closeOnClick: false,
						autoClose: false
					}
					);
				markers[username] = m;
				markerGroup.addLayer(m);
				map.panTo([lat, lon], {animate: true});
			}

			updateInfoPanel();
			updateActiveUsersList();
		}

		function removeMarker(username) {
			if (markers[username]) {
				markerGroup.removeLayer(markers[username]);
				delete markers[username];
				delete lastUpdateTimes[username];
				if (inactivityTimeout[username]) {
					clearTimeout(inactivityTimeout[username]);
					delete inactivityTimeout[username];
				}
				updateInfoPanel();
				updateActiveUsersList();
				console.log('Marker removed for: ' + username);
			}
		}

		function updateInfoPanel() {
			document.getElementById('userCount').textContent = Object.keys(markers).length;
			document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
		}

		function updateActiveUsersList() {
			const usersList = document.getElementById('activeUsersList');
			const users = Object.keys(markers).sort();

			usersList.innerHTML = '';

			if (users.length === 0) {
				usersList.innerHTML = '<div class="empty-users">No active users</div>';
				return;
			}

			users.forEach(username => {
				const userItem = document.createElement('div');
				userItem.className = 'user-item';
				userItem.textContent = username;
				userItem.onclick = function () {
					const marker = markers[username];
					if (marker) {
						map.setView(marker.getLatLng(), 16);
						marker.openPopup();
					}
				};
				usersList.appendChild(userItem);
			});
		}

		function updateStatus(connected) {
			const statusEl = document.getElementById('status');
			if (connected) {
				statusEl.className = 'status connected';
			} else {
				statusEl.className = 'status disconnected';
			}
		}

		function showAllMarkers() {
			const latlngs = Object.values(markers).map(m => m.getLatLng());
			if (latlngs.length === 0) {
				alert('No active users to display');
				return;
			}
			const bounds = L.latLngBounds(latlngs);
			map.fitBounds(bounds.pad(0.2));
		}
	</script>
</body>

</html>
