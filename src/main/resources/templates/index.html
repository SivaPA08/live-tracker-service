<!-- index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>GPS Location Sender</title>
	<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 20px;
		}

		.container {
			background: white;
			padding: 40px;
			border-radius: 16px;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
			max-width: 400px;
			width: 100%;
		}

		h2 {
			color: #333;
			margin-bottom: 24px;
			text-align: center;
		}

		.input-group {
			margin-bottom: 20px;
		}

		label {
			display: block;
			margin-bottom: 8px;
			color: #555;
			font-weight: 500;
		}

		input {
			width: 100%;
			padding: 12px;
			border: 2px solid #e0e0e0;
			border-radius: 8px;
			font-size: 16px;
			transition: border-color 0.3s;
		}

		input:focus {
			outline: none;
			border-color: #667eea;
		}

		button {
			width: 100%;
			padding: 14px;
			border: none;
			border-radius: 8px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s;
			margin-bottom: 12px;
		}

		#startBtn {
			background: #667eea;
			color: white;
		}

		#startBtn:hover:not(:disabled) {
			background: #5568d3;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
		}

		#stopBtn {
			background: #f44336;
			color: white;
		}

		#stopBtn:hover:not(:disabled) {
			background: #d32f2f;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
		}

		button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.status {
			margin-top: 20px;
			padding: 12px;
			border-radius: 8px;
			text-align: center;
			font-size: 14px;
			display: none;
		}

		.status.active {
			display: block;
			background: #e8f5e9;
			color: #2e7d32;
			border: 1px solid #a5d6a7;
		}

		.status.error {
			display: block;
			background: #ffebee;
			color: #c62828;
			border: 1px solid #ef9a9a;
		}

		.info {
			margin-top: 16px;
			padding: 12px;
			background: #f5f5f5;
			border-radius: 8px;
			font-size: 13px;
			color: #666;
		}

		.info p {
			margin: 4px 0;
		}

		.pulse {
			display: inline-block;
			width: 10px;
			height: 10px;
			border-radius: 50%;
			background: #4CAF50;
			margin-right: 8px;
			animation: pulse 2s infinite;
		}

		@keyframes pulse {

			0%,
			100% {
				opacity: 1;
			}

			50% {
				opacity: 0.3;
			}
		}
	</style>
</head>

<body>
	<div class="container">
		<h2>üìç GPS Location Tracker</h2>

		<div class="input-group">
			<label for="username">Username</label>
			<input id="username" type="text" placeholder="Enter your username" autocomplete="off" />
		</div>

		<button id="startBtn">Start Tracking</button>
		<button id="stopBtn" disabled>Stop Tracking</button>

		<div id="status" class="status"></div>

		<div class="info" id="locationInfo">
			<p><strong>Working:</strong></p>
			<p>ur location will be mine</p>
			<p>let me track all ur location pls</p>
			<p>dont turn off ur phone</p>
		</div>

		<div id="currentLocation" class="info"
			style="display:none; margin-top: 12px; background: #e3f2fd; border: 1px solid #90caf9;">
			<p><strong>ur location btw:</strong></p>
			<p><strong>User:</strong> <span id="displayUsername">-</span></p>
			<p><strong>Latitude:</strong> <span id="displayLat">-</span></p>
			<p><strong>Longitude:</strong> <span id="displayLon">-</span></p>
			<p style="font-size: 11px; color: #888; margin-top: 4px;">Last updated: <span id="displayTime">-</span></p>
		</div>
	</div>

	<script>
		let stompClient = null;
		let intervalId = null;
		let currentUsername = null;
		let lastPosition = null;

		document.getElementById('startBtn').addEventListener('click', startTracking);
		document.getElementById('stopBtn').addEventListener('click', stopTracking);

		// Allow Enter key to start tracking
		document.getElementById('username').addEventListener('keypress', function (e) {
			if (e.key === 'Enter' && !document.getElementById('startBtn').disabled) {
				startTracking();
			}
		});

		function startTracking() {
			const username = document.getElementById('username').value.trim();

			if (!username) {
				showStatus('Please enter a username', 'error');
				return;
			}

			currentUsername = username;

			// Check if geolocation is supported
			if (!navigator.geolocation) {
				showStatus('Geolocation is not supported by your browser', 'error');
				return;
			}

			// Connect to WebSocket
			const socket = new SockJS('/ws');
			stompClient = Stomp.over(socket);
			if (stompClient && stompClient.debug) stompClient.debug = null;

			stompClient.connect({}, function (frame) {
				console.log('Connected: ' + frame);
				showStatus('Connected! Sending location every 5 seconds...', 'active');

				// Show current location div
				document.getElementById('currentLocation').style.display = 'block';
				document.getElementById('displayUsername').textContent = currentUsername;

				// Get initial position
				sendCurrentLocation();

				// Send location every 5 seconds
				intervalId = setInterval(sendCurrentLocation, 5000);

				// Update UI
				document.getElementById('startBtn').disabled = true;
				document.getElementById('stopBtn').disabled = false;
				document.getElementById('username').disabled = true;

			}, function (error) {
				console.error('WebSocket connection error:', error);
				showStatus('Connection failed. Please check your connection.', 'error');
			});
		}

		function sendCurrentLocation() {
			if (!navigator.geolocation) {
				showStatus('Geolocation not supported', 'error');
				return;
			}

			navigator.geolocation.getCurrentPosition(
				function (position) {
					lastPosition = position;
					const payload = {
						username: currentUsername,
						latitude: position.coords.latitude,
						longitude: position.coords.longitude
					};

					// Update UI with current location FIRST (so user sees it immediately)
					document.getElementById('displayLat').textContent = position.coords.latitude.toFixed(6);
					document.getElementById('displayLon').textContent = position.coords.longitude.toFixed(6);
					document.getElementById('displayTime').textContent = new Date().toLocaleTimeString();

					// Then send to server
					if (stompClient && stompClient.connected) {
						stompClient.send('/app/location', {}, JSON.stringify(payload));
						console.log('‚úì Sent location:', payload);

						const now = new Date().toLocaleTimeString();
						showStatus(`<span class="pulse"></span>Location sent at ${now}`, 'active');
					} else {
						console.warn('WebSocket not connected, cannot send location');
						showStatus('Connection lost. Reconnecting...', 'error');
					}
				},
				function (error) {
					console.error('Geolocation error:', error);
					let errorMsg = 'Error getting location: ';
					switch (error.code) {
						case error.PERMISSION_DENIED:
							errorMsg += 'Permission denied';
							break;
						case error.POSITION_UNAVAILABLE:
							errorMsg += 'Position unavailable';
							break;
						case error.TIMEOUT:
							errorMsg += 'Request timeout';
							break;
						default:
							errorMsg += 'Unknown error';
					}
					showStatus(errorMsg, 'error');
				},
				{
					enableHighAccuracy: true,
					maximumAge: 0,
					timeout: 10000
				}
			);
		}

		function stopTracking() {
			// Clear interval
			if (intervalId) {
				clearInterval(intervalId);
				intervalId = null;
			}

			// Disconnect WebSocket
			if (stompClient && stompClient.connected) {
				try {
					stompClient.disconnect();
				} catch (e) {
					console.error('Error disconnecting:', e);
				}
				stompClient = null;
			}

			// Update UI
			document.getElementById('startBtn').disabled = false;
			document.getElementById('stopBtn').disabled = true;
			document.getElementById('username').disabled = false;
			document.getElementById('currentLocation').style.display = 'none';

			showStatus('Tracking stopped', 'error');
			console.log('Stopped tracking');
		}

		function showStatus(message, type) {
			const statusEl = document.getElementById('status');
			statusEl.innerHTML = message;
			statusEl.className = 'status ' + type;
		}

		// Clean up on page unload
		window.addEventListener('beforeunload', function () {
			stopTracking();
		});
	</script>
</body>

</html>
